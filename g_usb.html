<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KLAP_DEGI_USB</title>
    <style>
        :root { 
            --hrc-red: #E4002B; 
            --hrc-blue: #004098; 
            --hrc-white: #ffffff; 
            --bg-dark: #000000; 
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: var(--bg-dark); color: var(--hrc-white); 
            font-family: 'Arial Black', sans-serif; overflow: hidden; 
        }

        #dashboard { display: flex; flex-direction: column; height: 100dvh; width: 100vw; padding-top: 4px; box-sizing: border-box; }
        .top-section { flex: 1; position: relative; overflow: hidden; }
        #canvas { width: 100%; height: 100%; display: block; }

        #info-overlay { 
            position: absolute; top: 68%; right: 290px; 
            transform: translateY(-50%); display: flex; 
            flex-direction: column; align-items: flex-end; 
            pointer-events: none; z-index: 10; 
        }
        #rpm_val { font-size: 20vh; font-weight: 900; line-height: 0.75; text-shadow: 0 0 15px #000; }
        #display1 { font-size: 15vh; font-weight: 900; line-height: 1.0; margin-top: 15px; text-shadow: 0 0 15px #000; }
        #display { font-size: 4.5vh; color: #bbb; font-weight: bold; margin-top: 5px; text-shadow: 0 0 10px #000; }

        .right-panels { position: absolute; right: 15px; top: 120px; width: 250px; height: calc(100% - 130px); display: grid; grid-template-columns: 160px 80px; gap: 10px; z-index: 20; }
        #col-2 { overflow-y: auto; height: 100%; scrollbar-width: none; }
        .lap-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: 'monospace'; font-size: 20px; font-weight: bold; }
        .best-lap { color: var(--hrc-red); }

        .data-box { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 20px; }
        .label { font-size: 11px; color: var(--hrc-red); font-weight: bold; margin-bottom: -5px; }
        .val { font-size: 36px; font-weight: 900; line-height: 1; }

        footer { height: 45px; display: flex; gap: 4px; padding: 4px; background: #000; border-top: 1px solid #333; z-index: 100; }

        /* ボタンの基本スタイル */
        button { 
            flex: 1; height: 100%; background-color: #1a1a1a; color: #fff; 
            border: 1px solid #444; border-radius: 4px; 
            font-size: 11px; font-weight: bold; cursor: pointer;
            transition: all 0.2s ease;
        }
        button.active { background-color: var(--hrc-red) !important; border-color: var(--hrc-red); }
    </style>
</head>
<body>
    <div id="dashboard">
        <div class="top-section">
            <div id="tacho-layer">
                <canvas id="canvas"></canvas>
                <div id="info-overlay">
                    <div id="rpm_digital"><span id="rpm_val">0</span><span style="font-size:3vh; margin-left:10px;">rpm</span></div>
                    <div id="display1">00:00.000</div>
                    <div id="display">TOTAL 00:00.000</div>
                </div>
            </div>
            <div class="right-panels">
                <div id="col-2"><div id="lap"></div></div>
                <div id="col-3">
                    <div class="data-box"><div class="label">SPEED</div><span class="val" id="speed_val">0</span></div>
                    <div class="data-box"><div class="label">TEMP</div><span class="val" id="temp_val">--</span></div>
                </div>
            </div>
        </div>
        <footer>
            <button id="btConnect">BLE START</button>
            <button id="usbGpsBtn">USB GPS</button>
            <button id="startBtn">TIMER START</button>
            <button id="lapBtn">LAP/RESET</button>
            <button id="reloadBtn">RELOAD</button>
        </footer>
    </div>

<script>
'use strict';
let currentRPM = 0, device = null, nmeaBuffer = '', lastPos = null, lastLapTime = 0;
let LAP_LINE_P1 = { lat: 0, lon: 0 }, LAP_LINE_P2 = { lat: 0, lon: 0 };
let gpsThresholdValue = 20, lapCoolDown = 30000, pulseCount = 1;
let swState = 0, startTime = 0, lapStartTime = 0, lapRecords = [];
let lastUsbDataTime = 0, lastBleDataTime = 0;

const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');

// --- 修正版：ボタンの状態更新を確実に行う関数 ---
function getSettings() {
    const p1Lat = localStorage.getItem('startLineP1Lat');
    const p1Lon = localStorage.getItem('startLineP1Lon');
    const p2Lat = localStorage.getItem('startLineP2Lat');
    const p2Lon = localStorage.getItem('startLineP2Lon');
    const reloadBtn = document.getElementById('reloadBtn');

    if (!reloadBtn) return false;

    // 座標データが存在するかチェック
    if (p1Lat && p1Lon && p2Lat && p2Lon) {
        LAP_LINE_P1 = { lat: parseFloat(p1Lat), lon: parseFloat(p1Lon) };
        LAP_LINE_P2 = { lat: parseFloat(p2Lat), lon: parseFloat(p2Lon) };
        gpsThresholdValue = parseFloat(localStorage.getItem('gpsThreshold')) || 20;
        lapCoolDown = parseFloat(localStorage.getItem('lapCoolDownTime')) || 30000;
        pulseCount = parseInt(localStorage.getItem('pl1')) || 1;
        
        // 成功：通常のグレーに戻す
        reloadBtn.style.backgroundColor = "#1a1a1a";
        reloadBtn.style.color = "#ffffff";
        reloadBtn.textContent = "RELOAD";
        return true;
    } else {
        // 失敗：オレンジにする
        reloadBtn.style.backgroundColor = "#FFA500";
        reloadBtn.style.color = "#000000";
        reloadBtn.textContent = "NO SETTING";
        return false;
    }
}

// RELOADボタンをクリックした時の処理
document.getElementById('reloadBtn').onclick = function() {
    this.style.transform = "scale(0.9)";
    const success = getSettings(); 

    if (success) {
        // 読み込み成功時のみ青く光らせる
        this.style.backgroundColor = "#004098";
        this.style.color = "#ffffff";
        this.textContent = "LOADED!";
        setTimeout(() => {
            this.style.transform = "scale(1)";
            this.style.backgroundColor = "#1a1a1a"; 
            this.textContent = "RELOAD";
        }, 800);
    } else {
        // 失敗時はオレンジのまま
        setTimeout(() => { this.style.transform = "scale(1)"; }, 150);
        console.log("Settings not found in LocalStorage.");
    }
};

// --- 以下、基本ロジック ---
function renderLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const w = canvas.width, h = canvas.height;
    const segments = 60, active = Math.floor((currentRPM/14000)*segments);
    for (let i = 0; i < segments; i++) {
        let curRpm = (i/segments)*14000;
        ctx.fillStyle = i < active ? (curRpm >= 12500 ? "#E4002B" : "#FFFFFF") : "#222";
        ctx.fillRect(i * (w/segments), h-20, (w/segments)-2, 20);
    }
    document.getElementById('rpm_val').textContent = Math.floor(currentRPM);
    requestAnimationFrame(renderLoop);
}

window.onresize = () => { 
    canvas.width = canvas.parentElement.clientWidth; 
    canvas.height = canvas.parentElement.clientHeight; 
};

// 起動時に実行
window.onload = () => { 
    window.dispatchEvent(new Event('resize')); 
    getSettings(); // ここでボタンの色が決定されます
    renderLoop(); 
};
</script>
</body>
</html>
