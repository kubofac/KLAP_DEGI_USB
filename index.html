<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>GPS設定ツール Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="manifest" href="/manifest.json">
    <style>
        body { font-family: sans-serif; padding: 10px; background-color: #f0f0f0; margin: 0; }
        /* 地図の横幅を94%に制限して左右にスクロール用の隙間を作る */
        #map-container { position: relative; width: 94%; margin: 10px auto; }
        #mapid { height: 350px; width: 100%; border-radius: 8px; z-index: 1; }
        
        #map-controls { 
            position: absolute; top: 10px; right: 10px; z-index: 1000; 
            background: rgba(255,255,255,0.9); padding: 5px; border-radius: 5px; 
            display: flex; flex-direction: column; gap: 5px;
        }
        .control-group { background: white; padding: 15px; border-radius: 8px; margin: 10px auto; width: 94%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        
        button { background-color: #444; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:active { background-color: #222; }
        .btn-p1 { background-color: #d9534f; } /* 赤 */
        .btn-p2 { background-color: #0275d8; } /* 青 */
        .btn-decide { background-color: #5cb85c; font-size: 18px; } /* 緑 */
        .nav-button { background-color: #f0ad4e; color: #000; font-size: 18px; } /* オレンジ */

        .result-text { font-size: 13px; font-weight: bold; color: #555; }
        #instructionMessage { color: #d9534f; font-weight: bold; font-size: 14px; padding: 0 15px; }
    </style>
</head>
<body>
    <h2 style="text-align:center;">GPS設定ツール</h2>
    <p id="instructionMessage">現在地を取得中...</p>

    <div id="map-container">
        <div id="mapid"></div>
        <div id="map-controls">
            <button class="btn-p1" id="btnP1">P1設置</button>
            <button class="btn-p2" id="btnP2">P2設置</button>
        </div>
    </div>

    <div class="control-group">
        <button class="btn-decide" id="btnDecide">スタートラインを決定・保存</button>
        <button class="nav-button" onclick="location.href='g_usb.html'">ラップタイマー画面へ移動</button>
    </div>

    <div class="control-group">
        <label>サーキット選択:</label>
        <select id="circuitSelect"><option value="">-- プリセットから選択 --</option></select>
        <button id="saveCircuitButton">サーキットを適用</button>
        <div id="clickCoordinates" class="result-text">座標: 未設定</div>
    </div>

    <div class="control-group">
        <label>USB-GPS 接続設定:</label>
        <button id="usbTestBtn" style="background-color: #6c757d;">USB GPS 接続テストと保存</button>
        <div id="usbStatus" class="result-text">未設定</div>
    </div>

    <div class="control-group">
        <label>点火パルス数 (1回転あたり):</label>
        <select id="pulseSelect">
            <option value="0.5">0.5</option><option value="1" selected>1</option>
            <option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
        <button id="savePulseButton">パルス数を保存</button>
        <div id="setPulse" class="result-text">設定なし</div>
    </div>

    <div class="control-group">
        <label>計測閾値 / クールダウン:</label>
        <select id="thresholdSelect">
            <script>for(let i=5; i<=50; i+=5) document.write(`<option value="${i}" ${i==20?'selected':''}>${i}m</option>`);</script>
        </select>
        <button id="saveThresholdButton">閾値を保存</button>
        
        <select id="lapCoolDownSelect" style="margin-top:10px;">
            <option value="20000">20秒</option><option value="30000" selected>30秒</option>
            <option value="40000">40秒</option><option value="50000">50秒</option>
            <option value="60000">60秒</option><option value="90000">90秒</option>
            <option value="120000">120秒</option><option value="180000">180秒</option>
        </select>
        <button id="saveLapCoolDownButton">クールダウンを保存</button>
    </div>

    <div class="control-group" style="background: #fff0f0;">
        <button id="resetStorageButton" style="background: #d9534f;">全設定を初期化</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="circuit_data.js"></script>

    <script>
        let map, startMarker, endMarker, line, currentCircle;
        let p1Temp = null, p2Temp = null;

        function initMap() {
            map = L.map('mapid').setView([35.68, 139.76], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // 現在地の表示
            navigator.geolocation.watchPosition(pos => {
                const latlng = [pos.coords.latitude, pos.coords.longitude];
                if (!currentCircle) {
                    currentCircle = L.circle(latlng, { radius: 5, color: 'blue', fillOpacity: 0.6 }).addTo(map);
                    map.setView(latlng, 17);
                } else {
                    currentCircle.setLatLng(latlng);
                }
                document.getElementById('instructionMessage').textContent = "P1/P2ボタンでマーカーを出し、ドラッグして位置を合わせてください。";
            }, null, { enableHighAccuracy: true });
        }

        // マーカー設置（残像が出ないよう既存を削除してから作成）
        function placeMarker(type) {
            const center = map.getCenter();
            if (type === 'p1') {
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.marker(center, { draggable: true, title: "P1" }).addTo(map);
                p1Temp = center;
                startMarker.on('dragend', e => { p1Temp = e.target.getLatLng(); updatePreviewLine(); });
            } else {
                if (endMarker) map.removeLayer(endMarker);
                endMarker = L.marker(center, { draggable: true, title: "P2" }).addTo(map);
                p2Temp = center;
                endMarker.on('dragend', e => { p2Temp = e.target.getLatLng(); updatePreviewLine(); });
            }
            updatePreviewLine();
        }

        // プレビュー線の更新
        function updatePreviewLine() {
            if (line) map.removeLayer(line);
            if (p1Temp && p2Temp) {
                line = L.polyline([p1Temp, p2Temp], { color: 'red', weight: 3, dashArray: '5, 5' }).addTo(map);
            }
        }

        // スタートラインの決定保存
        document.getElementById('btnDecide').onclick = () => {
            if (!p1Temp || !p2Temp) {
                alert("P1とP2の両方を設置してください。");
                return;
            }
            localStorage.setItem('startLineP1Lat', p1Temp.lat);
            localStorage.setItem('startLineP1Lon', p1Temp.lng);
            localStorage.setItem('startLineP2Lat', p2Temp.lat);
            localStorage.setItem('startLineP2Lon', p2Temp.lng);
            
            if (line) line.setStyle({ dashArray: null, color: 'red' });
            alert("スタートラインを保存しました。");
            displayStatus();
        };

        function displayStatus() {
            const p1 = localStorage.getItem('startLineP1Lat') ? "P1:OK" : "P1:--";
            const p2 = localStorage.getItem('startLineP2Lat') ? "P2:OK" : "P2:--";
            document.getElementById('clickCoordinates').textContent = `保存済み: ${p1} / ${p2}`;
        }

        // サーキット読み込み (circuitData オブジェクト形式に対応)
        function loadCircuitList() {
            if (typeof circuitData !== 'undefined') {
                const sel = document.getElementById('circuitSelect');
                // オブジェクトのキーをループ
                Object.keys(circuitData).forEach(key => {
                    let o = document.createElement('option');
                    o.value = key;
                    o.textContent = circuitData[key].name;
                    sel.appendChild(o);
                });
            }
        }

        document.getElementById('saveCircuitButton').onclick = () => {
            const id = document.getElementById('circuitSelect').value;
            if (id !== "" && circuitData[id]) {
                const data = circuitData[id];
                // [Lon, Lat] 形式を [Lat, Lon] に変換してセット
                p1Temp = { lat: data.startLineP1[1], lng: data.startLineP1[0] };
                p2Temp = { lat: data.startLineP2[1], lng: data.startLineP2[0] };

                if (startMarker) map.removeLayer(startMarker);
                if (endMarker) map.removeLayer(endMarker);

                startMarker = L.marker(p1Temp, { draggable: true }).addTo(map);
                endMarker = L.marker(p2Temp, { draggable: true }).addTo(map);
                
                startMarker.on('dragend', e => { p1Temp = e.target.getLatLng(); updatePreviewLine(); });
                endMarker.on('dragend', e => { p2Temp = e.target.getLatLng(); updatePreviewLine(); });

                map.setView(p1Temp, 17);
                updatePreviewLine();
                alert(`${data.name} の座標を読み込みました。「決定」を押すと保存されます。`);
            }
        };

        // USB設定
        document.getElementById('usbTestBtn').onclick = async () => {
            try {
                const device = await navigator.usb.requestDevice({ filters: [] });
                await device.open();
                localStorage.setItem('usb_interface', 1);
                localStorage.setItem('usb_endpoint', 2);
                document.getElementById('usbStatus').textContent = "保存完了: IF-1 / EP-2";
                await device.close();
            } catch (e) { document.getElementById('usbStatus').textContent = "キャンセル"; }
        };

        // その他の保存
        document.getElementById('btnP1').onclick = () => placeMarker('p1');
        document.getElementById('btnP2').onclick = () => placeMarker('p2');
        document.getElementById('savePulseButton').onclick = () => { localStorage.setItem('pl1', document.getElementById('pulseSelect').value); alert("保存しました"); };
        document.getElementById('saveThresholdButton').onclick = () => { localStorage.setItem('gpsThreshold', document.getElementById('thresholdSelect').value); alert("保存しました"); };
        document.getElementById('saveLapCoolDownButton').onclick = () => { localStorage.setItem('lapCoolDownTime', document.getElementById('lapCoolDownSelect').value); alert("保存しました"); };
        document.getElementById('resetStorageButton').onclick = () => { if(confirm("全消去しますか？")) { localStorage.clear(); location.reload(); } };

        window.onload = () => {
            initMap();
            loadCircuitList();
            displayStatus();
        };
    </script>
</body>
</html>

